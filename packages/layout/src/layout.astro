---
import { PaperLink, Divider } from "@cieloazul310/astro-sarkara-components";
import {
  defineMenu,
  withBaseUrl,
  type Menu,
} from "@cieloazul310/astro-sarkara-utils";
import { css, sva, type RecipeVariantProps } from "styled-system/css";

import Seo, { type Props as SeoProps } from "./seo.astro";
import Header from "./header.astro";
import Drawer from "./drawer.astro";
import Footer from "./footer.astro";
import Jumbotron from "./jumbotron.astro";
import Fab from "./fab.astro";
import MenuList from "./menu.astro";

const defaultMenu = defineMenu([
  { title: "Top", href: "/" },
  {
    title: "Link",
    items: [
      { title: "Astro", href: "https://astro.build/" },
      { title: "Panda CSS", href: "https://panda-css.com/" },
      {
        title: "GitHub Repo",
        href: "https://github.com/cieloazul310/astro-sarkara",
      },
    ],
  },
]);

const layoutStyle = sva({
  slots: ["header", "jumbotron", "grid", "main", "sidebar", "fab"],
  base: {
    header: {
      position: "sticky",
      top: 0,
      height: "headerHeight",
      px: 4,
      display: "flex",
      alignItems: "center",
      justifyContent: ["center", "start"],
      zIndex: "header",
      color: "white",
      bgGradient: "to-r",
      gradientFrom: { base: "primary.600", _dark: "primary.800" },
      gradientTo: { base: "secondary.100", _dark: "bg" },
    },
    jumbotron: {
      p: [4, 8],
      height: "480px",
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      color: "white",
      bgGradient: "to-r",
      gradientFrom: { base: "primary.600", _dark: "primary.800" },
      gradientTo: { base: "secondary.100", _dark: "bg" },
    },
    grid: {
      display: "grid",
      maxWidth: "contentMaxWidth",
      px: 2,
      py: 4,
      mx: "auto",
    },
    main: {
      display: "grid",
      gridTemplateColumns: "minmax(0, 1fr)",
      gap: "md",
      px: [0, 2],
      maxWidth: "full",
    },
    sidebar: {
      width: "sidebarWidth",
      px: 2,
      pb: 8,
      display: "grid",
      gridTemplateColumns: "minmax(0, 1fr)",
      gridAutoRows: "max-content",
      gap: "md",
    },
    fab: {
      position: "fixed",
      bottom: 4,
      right: 4,
      zIndex: "fab",
    },
  },
  variants: {
    variant: {
      default: {
        grid: {
          gridTemplateColumns: {
            base: "minmax(0, 1fr)",
            md: `minmax(0, 1fr) minmax(0, token(sizes.sidebarWidth))`,
          },
        },
        sidebar: { display: { base: "none", md: "grid" } },
        fab: { display: { base: "block", md: "none" } },
      },
      fullWidth: {
        grid: {
          gridTemplateColumns: "minmax(0, 1fr)",
        },
        sidebar: { display: "none" },
        fab: { display: "block" },
      },
    },
    sidebarSticky: {
      true: {
        sidebar: {
          position: "sticky",
          top: "calc(token(sizes.headerHeight) + token(spacing.4))",
          maxHeight: "calc(100vh - token(sizes.headerHeight))",
          overflowY: "auto",
        },
      },
    },
  },
  defaultVariants: {
    variant: "default",
    sidebarSticky: true,
  },
});

export type Props = SeoProps &
  RecipeVariantProps<typeof layoutStyle> & {
    menu?: Menu;
    htmlLang?: string;
    disableSidebarSticky?: boolean;
  };

const {
  siteMetadata,
  title,
  description,
  image,
  variant = "default",
  htmlLang = "ja",
  menu = defaultMenu,
  disableSidebarSticky = false,
  siteType = "website",
  twitterCardType = "summary",
} = Astro.props;

const { header, grid, jumbotron, main, sidebar, fab } = layoutStyle({
  variant,
  sidebarSticky: !disableSidebarSticky,
});

const contentTitle =
  title && title !== siteMetadata.title
    ? `${title} - ${siteMetadata.title}`
    : siteMetadata.title;
const favicon = {
  type:
    !siteMetadata.favicon ||
    siteMetadata.favicon?.split(".").slice(-1)[0] === "svg"
      ? "image/svg+xml"
      : null,
  href: withBaseUrl(siteMetadata.favicon ?? "/favicon.svg"),
};
---

<!doctype html>
<html lang={htmlLang}>
  <head>
    <slot name="top-of-head" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type={favicon.type} href={favicon.href} />
    <meta name="generator" content={Astro.generator} />
    <title>{contentTitle}</title>
    <slot name="seo">
      <Seo
        siteMetadata={siteMetadata}
        title={title}
        description={description}
        image={image}
        siteType={siteType}
        twitterCardType={twitterCardType}
      >
        <slot name="meta" />
      </Seo>
    </slot>
    <slot name="bottom-of-head" />
  </head>
  <body>
    <slot name="top-of-body" />
    <slot name="header">
      <Header className={header} siteTitle={siteMetadata.title} />
    </slot>
    <main>
      <article>
        <slot name="jumbotron">
          <Jumbotron className={jumbotron} title={title || siteMetadata.title}>
            <slot name="jumbotron-header" slot="jumbotron-header" />
            <slot name="jumbotron-footer" slot="jumbotron-footer" />
          </Jumbotron>
        </slot>
        <div class={grid}>
          <div class={main}>
            <slot name="top-of-main" />
            <slot />
            <div class={css({ hideFrom: "md" })}>
              <MenuList menu={menu} />
            </div>
            <PaperLink className={css({ hideBelow: "md" })} href="/">
              Top
            </PaperLink>
            <slot name="bottom-of-main" />
          </div>
          <div class={sidebar}>
            <slot name="sidebar">
              <slot name="sidebar-top" />
              {Astro.slots.has("sidebar-top") && <Divider />}
              <MenuList menu={menu} />
              {Astro.slots.has("sidebar-bottom") && <Divider />}
              <slot name="sidebar-bottom" />
            </slot>
          </div>
        </div>
      </article>
    </main>
    <slot name="footer">
      <Footer siteTitle={siteMetadata.title} />
    </slot>
    <div class={fab}>
      <slot name="fab">
        <Fab />
      </slot>
    </div>
    <slot name="drawer">
      <Drawer siteTitle={siteMetadata.title}>
        <slot name="drawer-top" slot="drawer-top" />
        <MenuList menu={menu} />
        <slot name="drawer-bottom" slot="drawer-bottom" />
      </Drawer>
    </slot>
    <script>
      import "./scripts/toggleColorMode.ts";
    </script>
    <script is:inline>
      function setDarkMode() {
        const theme = (() => {
          if (
            typeof localStorage !== "undefined" &&
            localStorage.getItem("theme")
          ) {
            return localStorage.getItem("theme");
          }
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            return "dark";
          }
          return "light";
        })();

        if (theme === "light") {
          document.documentElement.classList.remove("dark");
        } else {
          document.documentElement.classList.add("dark");
        }

        window.localStorage.setItem("theme", theme);
      }

      setDarkMode();
      document.addEventListener("astro:after-swap", setDarkMode);
    </script>
    <slot name="bottom-of-body" />
  </body>
</html>
